#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

RACKET_VERSION=5.3.5
RACKET_ARCH="x86_64-linux-ubuntu-precise"
RACKET_URL="http://download.racket-lang.org/installers/$RACKET_VERSION/racket/racket-$RACKET_VERSION-bin-$RACKET_ARCH.sh"
RACKET_DIR=

make_tempdir()
{
  dir=$(mktemp -t -u node-$1-XXXXXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

get_racket() {
  dir=$1
  cd $dir
  curl $RACKET_URL -o racket-install.sh
  chmod u+rx racket-install.sh
  echo `pwd`
}

build_racket() {
  dir=$1
  cd $dir
  ./racket-install.sh <<EOF
no
4

EOF
  echo $dir/racket
}

indent() {
  sed -u 's/^/       /'
}

echo "-----> Building Racket Runtime Environment"
echo "-----> RACKET_URL=$RACKET_URL"

RACKET_DIR=$(build_racket $(get_racket $(make_tempdir racket)))
echo "-----> RACKET_DIR=$RACKET_DIR"

if [ ! -d $RACKET_DIR ]; then
  echo "Fail" | indent
  exit 1
fi

echo "-----> Creating racketapp From racketapp.mkt"
cd $RACKET_DIR
cd bin
raco exe -o $BUILD_DIR/racketapp $BUILD_DIR/racketapp.mkt

